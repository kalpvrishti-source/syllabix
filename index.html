<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta id="theme-color-meta" name="theme-color" content="#121213">
    
    <title>Syllabix</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-title" content="Syllabix">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        * { box-sizing: border-box; }

        :root {
            --correct: #6aaa64; 
            --present: #c9b458; 
            --absent: #3a3a3c;
            --bg: #121213; 
            --text: #ffffff; 
            --border: #3a3a3c;
        }

        body.high-contrast {
            --correct: #f5793a; 
            --present: #85c0f9; 
        }

        body.theme-mars {
            --bg: #260e0a; 
            --text: #fcdbd3; 
            --border: #592518;
            --correct: #d94b20; 
            --present: #e6a045; 
            --absent: #3d1b14;
        }

        body.theme-hacker {
            --bg: #050a05; 
            --text: #33ff33; 
            --border: #0f330f;
            --correct: #00cc00; 
            --present: #0088ff; 
            --absent: #0a1f0a;
        }

        body {
            background-color: transparent; 
            color: var(--text);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 20px 10px; min-height: 100vh;
            overflow-x: hidden;
            transition: color 0.4s; 
        }

        /* --- DYNAMIC BACKGROUND CANVAS --- */
        #theme-canvas {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -10; pointer-events: none;
        }

        /* --- SPLASH SCREEN STYLES --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.6s ease-in-out;
        }

        #splash-logo {
            width: 150px; height: auto; border-radius: 20px;
            box-shadow: 0 0 40px rgba(133, 192, 249, 0.3); opacity: 0;
            animation: popIn 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        #splash-title {
            margin-top: 20px; font-size: 2.5rem; letter-spacing: 4px; font-weight: bold;
            text-transform: uppercase; color: var(--text); opacity: 0; animation: fadeIn 1s ease-in 0.4s forwards;
        }

        #splash-text {
            margin-top: 10px; font-size: 0.9rem; color: #818384; letter-spacing: 2px;
            text-transform: uppercase; font-weight: bold; opacity: 0; animation: fadeIn 1s ease-in 0.8s forwards;
        }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { to { opacity: 1; } }
        
        /* --- CATEGORY SELECTION SCREEN --- */
        #category-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background-color: transparent;
            z-index: 5000; overflow-y: auto; 
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .cat-screen-inner {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100%; padding: 80px 20px 50px 20px; 
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        
        .cat-screen-title { font-size: 2rem; margin-bottom: 5px; letter-spacing: 2px; text-align: center; margin-top: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        .cat-screen-sub { color: var(--text); opacity: 0.8; margin-bottom: 30px; font-size: 0.9rem; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}

        .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; max-width: 500px; }

        .cat-btn-large {
            background-color: rgba(0,0,0,0.5); color: var(--text); border: 2px solid var(--border);
            padding: 20px 10px; border-radius: 12px; font-size: 1rem; font-weight: bold;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
            backdrop-filter: blur(5px);
        }

        .cat-btn-large:hover { border-color: var(--correct); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(106, 170, 100, 0.4); background-color: rgba(0,0,0,0.8); }
        
        /* --- MAIN GAME UI --- */
        .header { 
            width: 100%; max-width: 600px; display: grid; grid-template-columns: 1fr auto 1fr; 
            align-items: center; border-bottom: 1px solid var(--border); 
            padding-bottom: 15px; margin-bottom: 15px; transition: border-color 0.4s;
        }
        .header h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; text-align: center; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        .header-left { display: flex; gap: 8px; justify-content: flex-start; flex-wrap: wrap; }
        .header-right { display: flex; flex-direction: row; align-items: center; justify-content: flex-end; gap: 10px; font-size: 0.85rem; }
        #timer { font-family: monospace; font-size: 1.1rem; color: var(--text); opacity: 0.9; transition: color 0.3s, opacity 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        
        .icon-btn { 
            background: rgba(0,0,0,0.5); border: 2px solid var(--border); color: var(--text); 
            border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-weight: bold; font-size: 1.1rem;
            display: flex; justify-content: center; align-items: center; transition: all 0.2s; padding: 0; backdrop-filter: blur(5px);
        }
        .icon-btn:hover { background: var(--absent); border-color: var(--correct); }

        .game-wrapper {
            display: flex; flex-direction: row; gap: 40px;
            align-items: flex-start; justify-content: center;
            width: 100%; max-width: 800px; margin-top: 15px;
        }

        #game-container { display: flex; flex-direction: column; align-items: center; }
        .row { display: grid; grid-template-columns: repeat(5, 1fr); grid-gap: 6px; margin-bottom: 6px; }
        
        .tile {
            width: 60px; height: 60px; border: 2px solid var(--border);
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; font-weight: bold; text-transform: uppercase;
            transition: border-color 0.4s, background-color 0.4s;
            background-color: rgba(0,0,0,0.4); 
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* --- TRACKER / KEYBOARD STYLES --- */
        .tracker-board { padding-top: 5px; pointer-events: none; } 
        .tracker-title { 
            font-size: 0.8rem; color: var(--text); opacity: 0.9; 
            text-align: center; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
            display: block; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .tk-row { display: flex; justify-content: center; gap: 6px; margin-bottom: 8px; width: 100%; }
        .tk-key {
            background-color: rgba(0,0,0,0.6); color: var(--text); flex: 1; height: 50px; 
            display: flex; justify-content: center; align-items: center; min-width: 32px;
            border-radius: 5px; font-weight: bold; font-size: 1.1rem; backdrop-filter: blur(5px);
            transition: background-color 0.4s, color 0.4s, transform 0.1s, filter 0.1s; user-select: none; border: 1px solid var(--border);
        }
        
        .active-flash { transform: scale(0.85); filter: brightness(1.5); }
        .tk-key:active { transform: scale(0.9); } 

        .tk-action { display: none; } 
        
        .tk-correct { background-color: var(--correct) !important; color: #fff !important; border-color: var(--correct) !important; text-shadow: none;}
        .tk-present { background-color: var(--present) !important; color: #fff !important; border-color: var(--present) !important; text-shadow: none;}
        .tk-absent { background-color: rgba(0,0,0,0.8) !important; opacity: 0.6; border-color: transparent !important; }
        .correct { background-color: var(--correct); border-color: var(--correct); color: #fff; text-shadow: none;}
        .present { background-color: var(--present); border-color: var(--present); color: #fff; text-shadow: none;}
        .absent { background-color: var(--absent); border-color: var(--absent); color: var(--text);}

        /* --- ANTI-CHEAT MODALS & SCROLL BARS --- */
        .modal {
            display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(10, 10, 10, 0.85); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: rgba(18, 18, 19, 0.95); color: var(--text); padding: 25px; border-radius: 12px;
            max-width: 400px; width: 90%; border: 1px solid var(--correct);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-content::-webkit-scrollbar { width: 4px; } 
        .modal-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        
        .settings-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 15px;
        }
        .settings-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .settings-label { font-weight: bold; font-size: 1rem; }
        
        select:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Stats & Level UI */
        .level-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;}
        .xp-bar-container { width: 100%; background: var(--absent); height: 12px; border-radius: 6px; margin-top: 5px; overflow: hidden; border: 1px solid var(--border);}
        .xp-bar-fill { background: linear-gradient(90deg, var(--present), var(--correct)); height: 100%; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .xp-text { font-size: 0.8rem; margin-top: 6px; opacity: 0.7; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}

        .stat-container { display: flex; justify-content: space-around; margin-bottom: 20px; text-align: center; gap: 10px;}
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-num { font-size: 1.8rem; font-weight: bold; }
        .stat-label { font-size: 0.70rem; opacity: 0.7; text-transform: uppercase; }
        .graph-row { display: flex; align-items: center; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold;}
        .graph-num { width: 15px; }
        .graph-bar { background-color: var(--absent); height: 20px; margin-left: 10px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; min-width: 20px; transition: background-color 0.4s; border: 1px solid var(--border);}
        .graph-bar.highlight { background-color: var(--correct); color: #fff;}

        .badges-container { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 15px; 
            padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid var(--border);
        }
        .badge { 
            display: flex; flex-direction: column; align-items: center; width: 65px; 
            text-align: center; transition: transform 0.3s; 
        }
        .badge:hover { transform: scale(1.1); }
        .badge-icon { 
            font-size: 2rem; margin-bottom: 5px; 
            filter: grayscale(100%) opacity(0.3); transition: all 0.5s; 
        }
        .badge.unlocked .badge-icon { 
            filter: grayscale(0%) opacity(1); text-shadow: 0 0 15px rgba(255,255,255,0.4); 
        }
        .badge-name { font-size: 0.65rem; font-weight: bold; line-height: 1.2; opacity: 0.4; }
        .badge.unlocked .badge-name { opacity: 1; color: var(--correct); }


        .dict-list { max-height: 250px; overflow-y: auto; text-align: left; font-size: 0.95rem; padding: 10px; border-radius: 5px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); }
        .dict-list p { margin: 8px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .dict-list p:last-child { border-bottom: none; }

        .example-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.95rem; }
        .mini-tile {
            width: 35px; height: 35px; display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.2rem; margin-right: 8px; border: 2px solid var(--border); border-radius: 4px;
        }

        /* UI Controls & Buttons */
        .controls { display: flex; gap: 12px; margin: 15px 0; align-items: center; font-size: 0.85rem; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 650px;}
        #message { height: 30px; color: var(--correct); font-weight: bold; margin: 5px; text-align: center; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        .error-msg { color: #ff5252 !important; }
        
        .action-btn { 
            background-color: var(--absent); color: var(--text); border: none; padding: 10px 18px; 
            border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 4px 6px rgba(0,0,0,0.5); 
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
        }

        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.7); filter: brightness(1.15); }
        .action-btn:active { transform: translateY(1px); box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .btn-hint { background: linear-gradient(135deg, #c9b458, #a39247); color: #121213; }
        .btn-giveup { background: linear-gradient(135deg, #d32f2f, #9a2222); color: #fff; }
        .btn-share { background: linear-gradient(135deg, #6aaa64, #4a8244); color: #fff; }
        .btn-define { background: linear-gradient(135deg, #9c27b0, #6a1b9a); color: #fff; } 
        .btn-restart { background: linear-gradient(135deg, #1976d2, #115293); color: #fff; }
        .btn-download { background: linear-gradient(135deg, #f5793a, #d45922); color: #fff; }
        .btn-neutral { background: #2a2a2c; color: var(--text); border: 1px solid var(--border); box-shadow: none; border-radius: 8px;}
        
        select { 
            background-color: #2a2a2c; color: var(--text); border: 1px solid var(--border); 
            padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; 
            font-size: 0.9rem; font-family: inherit; outline: none; transition: all 0.3s;
        }
        select:hover:not(:disabled) { border-color: var(--correct); }
        .toggle-label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: bold;}

        .flip { animation: flip 0.6s forwards; }
        @keyframes flip { 50% { transform: rotateX(90deg); } 100% { transform: rotateX(0deg); } }
        .shake { animation: shake 0.4s; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
            40%, 60% { transform: translate3d(8px, 0, 0); }
        }

        #tutorial-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 99999; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden;
        }
        .tut-hand {
            position: absolute; font-size: 2.5rem; opacity: 0;
            transition: top 0.4s cubic-bezier(0.25, 1, 0.5, 1), left 0.4s cubic-bezier(0.25, 1, 0.5, 1), transform 0.1s;
            z-index: 100000; pointer-events: none; user-select: none; text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .tut-text-box { font-size: 1.2rem; font-weight: bold; color: var(--present); text-align: center; height: 60px; margin-bottom: 20px; padding: 0 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}

        /* --- MOBILE SMART RESPONSIVENESS --- */
        @media (max-width: 700px) {
            .game-wrapper { flex-direction: column; align-items: center; gap: 20px; margin-top: 5px; width: 100%;}
            
            .tracker-board { width: 100%; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); pointer-events: auto; }
            .tracker-title { display: none; }
            .tk-action { display: flex; flex: 1.5; font-size: 0.8rem; }

            .header { display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px; border-color: rgba(255,255,255,0.1);}
            .header-left { justify-content: center; width: 100%; }
            .header h1 { font-size: 1.8rem; margin: 0; }
            .header-right { justify-content: center; width: 100%; }

            .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 95%; max-width: 400px; }
            .action-btn { width: 100%; padding: 12px 5px; font-size: 0.9rem; margin: 0; }
            #playAgainBtn { grid-column: 1 / -1; }

            .tile { width: 50px; height: 50px; font-size: 1.8rem; }
            
            .cat-grid { grid-template-columns: 1fr; }
            .tk-row { gap: 4px; margin-bottom: 6px; width: 100%; }
            .tk-key { height: 45px; font-size: 0.9rem; border-radius: 4px; min-width: 0; padding: 0;}
        }
    </style>
</head>
<body>

    <canvas id="theme-canvas"></canvas>

    <div id="splash-screen">
        <img src="icon.png" alt="Syllabix Logo" id="splash-logo" onerror="this.style.display='none'">
        <div id="splash-title">SYLLABIX</div>
        <div id="splash-text">Developed by Kalp Shah</div>
    </div>

    <div id="category-screen">
        <button class="icon-btn" onclick="triggerFeedback('ui-click'); playTutorial()" style="position: fixed; top: 20px; right: 20px; width: 45px; height: 45px; z-index: 5001;">‚ùì</button>

        <div class="cat-screen-inner">
            <h2 class="cat-screen-title">Choose Your Subject</h2>
            <div class="cat-screen-sub">Select a category to start the game</div>
            
            <div class="cat-grid">
                <button class="cat-btn-large" style="grid-column: 1 / -1; border-color: #9c27b0; color: #e1bee7; background: rgba(156, 39, 176, 0.2);" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); createChallengeLink()">üîó Stump a Friend üîó</button>
                <button class="cat-btn-large" style="grid-column: 1 / -1; border-color: var(--present); color: var(--present);" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Daily')">‚≠ê PLAY DAILY CHALLENGE ‚≠ê</button>
                
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('General')">üåç General</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Science')">üî≠ Science</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Chemistry')">üß™ Chemistry</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Biology')">üß¨ Biology</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Zoology')">ü¶Å Zoology</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Astronomy')">ü™ê Astronomy</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('History')">üèõÔ∏è History</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Maths')">‚ûó Maths / JEE</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Music')">üéµ Music Tech</button>
                <button class="cat-btn-large" onmouseenter="triggerFeedback('hover')" onclick="triggerFeedback('ui-click'); startGame('Geopolitics')">üåê Geopolitics</button>
            </div>
        </div>
    </div>

    <div id="tutorial-overlay">
        <button class="icon-btn" id="tutMuteBtn" onclick="toggleMute()" style="position: absolute; top: 20px; left: 20px; z-index: 100001;" title="Toggle Sound">üîä</button>
        <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); closeTutorial()" style="position: absolute; top: 20px; right: 20px; z-index: 100001;">Skip ‚è≠Ô∏è</button>
        
        <div id="tut-text" class="tut-text-box">Let's learn how to play!</div>
        
        <div id="tut-scene-1" style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            <div id="tut-cat-btn" class="cat-btn-large" style="width: 200px; text-align: center;">üåç General</div>
        </div>

        <div id="tut-scene-2" style="display: none; flex-direction: column; align-items: center; width: 100%; max-width: 500px; padding: 0 10px;">
            <div id="tut-game-container" style="display: flex; flex-direction: column; align-items: center;">
                <div class="row"><div class="tile" id="tut-t-0-0"></div><div class="tile" id="tut-t-0-1"></div><div class="tile" id="tut-t-0-2"></div><div class="tile" id="tut-t-0-3"></div><div class="tile" id="tut-t-0-4"></div></div>
                <div class="row"><div class="tile" id="tut-t-1-0"></div><div class="tile" id="tut-t-1-1"></div><div class="tile" id="tut-t-1-2"></div><div class="tile" id="tut-t-1-3"></div><div class="tile" id="tut-t-1-4"></div></div>
            </div>
            
            <div id="tut-keyboard" style="margin-top: 25px; pointer-events: none; width: 100%;">
                <div class="tk-row">
                    <div class="tk-key" id="tut-k-Q">Q</div><div class="tk-key" id="tut-k-W">W</div><div class="tk-key" id="tut-k-E">E</div><div class="tk-key" id="tut-k-R">R</div><div class="tk-key" id="tut-k-T">T</div><div class="tk-key" id="tut-k-Y">Y</div><div class="tk-key" id="tut-k-U">U</div><div class="tk-key" id="tut-k-I">I</div><div class="tk-key" id="tut-k-O">O</div><div class="tk-key" id="tut-k-P">P</div>
                </div>
                <div class="tk-row" style="padding: 0 5%;">
                    <div class="tk-key" id="tut-k-A">A</div><div class="tk-key" id="tut-k-S">S</div><div class="tk-key" id="tut-k-D">D</div><div class="tk-key" id="tut-k-F">F</div><div class="tk-key" id="tut-k-G">G</div><div class="tk-key" id="tut-k-H">H</div><div class="tk-key" id="tut-k-J">J</div><div class="tk-key" id="tut-k-K">K</div><div class="tk-key" id="tut-k-L">L</div>
                </div>
                <div class="tk-row">
                    <div class="tk-key tk-action" id="tut-k-ENTER" style="display:flex;">ENT</div><div class="tk-key" id="tut-k-Z">Z</div><div class="tk-key" id="tut-k-X">X</div><div class="tk-key" id="tut-k-C">C</div><div class="tk-key" id="tut-k-V">V</div><div class="tk-key" id="tut-k-B">B</div><div class="tk-key" id="tut-k-N">N</div><div class="tk-key" id="tut-k-M">M</div><div class="tk-key tk-action" id="tut-k-‚å´" style="display:flex;">‚å´</div>
                </div>
            </div>
        </div>

        <div id="tut-hand" class="tut-hand">üëÜ</div>
    </div>

    <div class="header">
        <div class="header-left">
            <button class="icon-btn" onclick="triggerFeedback('ui-click'); openSettings()" title="Settings">‚öôÔ∏è</button>
            <button class="icon-btn" onclick="triggerFeedback('ui-click'); toggleModal('helpModal')" title="How to play">?</button>
            <button class="icon-btn" onclick="triggerFeedback('ui-click'); openStats()" title="Statistics & Badges">üìä</button>
            <button class="icon-btn" onclick="triggerFeedback('ui-click'); toggleModal('dictModal')" title="Word Examples">üìö</button>
            <button class="icon-btn" onclick="triggerFeedback('ui-click'); openShareAppMenu()" title="Share or Download Game">üì•</button>
            <button class="icon-btn" id="muteBtn" onclick="toggleMute()" title="Toggle Sound">üîä</button>
        </div>
        <h1>SYLLABIX</h1>
        <div class="header-right">
            <span id="timer">00:00</span>
            <button class="icon-btn" onclick="togglePause()" title="Pause Game" style="width: 32px; height: 32px; font-size: 0.9rem;">‚è∏Ô∏è</button>
        </div>
    </div>

    <div class="controls">
        <button class="action-btn btn-hint" onclick="triggerFeedback('ui-click'); getHint()">üí° Hint</button>
        <button id="giveUpBtn" class="action-btn btn-giveup" onclick="triggerFeedback('ui-click'); giveUpWord()">üè≥Ô∏è Give Up</button>
        
        <button id="shareBtn" class="action-btn btn-share" style="display:none;" onclick="triggerFeedback('ui-click'); shareResults()">üì§ Share</button>
        <button id="defineBtn" class="action-btn btn-define" style="display:none;" onclick="triggerFeedback('ui-click'); openDictionary()">üìñ Define</button>
        <button id="playAgainBtn" class="action-btn btn-restart" style="display:none;" onclick="triggerFeedback('ui-click'); returnToMenu()">üîÑ Menu</button>
    </div>

    <div id="message"></div>

    <div class="game-wrapper">
        <div id="game-container"></div>
        <div class="tracker-board">
            <span class="tracker-title">Letter Tracker</span>
            <div id="tracker-keyboard"></div> 
        </div>
    </div>

    <div id="dailyLockModal" class="modal" onclick="closeDailyLock()">
        <div class="modal-content" style="text-align: center;" onclick="event.stopPropagation()">
            <h3 style="margin-top: 0; letter-spacing: 2px; color: var(--present);">DAILY CHALLENGE</h3>
            <p id="dailyLockMessage" style="line-height: 1.5; font-size: 1.1rem; margin-top: 20px;"></p>
            
            <div style="font-size: 2.5rem; font-weight: bold; margin: 25px 0; color: var(--correct); font-family: monospace;" id="dailyCountdown">00:00:00</div>
            <p style="opacity: 0.7; font-size: 0.8rem; text-transform: uppercase;">Until Next Word</p>
            
            <button class="action-btn btn-neutral" onclick="closeDailyLock()" style="margin-top:20px; width: 100%; border-radius:8px;">Back to Menu</button>
        </div>
    </div>

    <div id="settingsModal" class="modal" onclick="triggerFeedback('ui-click'); toggleModal('settingsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="text-align: center; margin-top: 0; letter-spacing: 2px;">SETTINGS</h3>
            
            <div class="settings-row">
                <span class="settings-label">Subject</span>
                <select id="categorySelect" onchange="triggerFeedback('ui-click'); changeCategoryMidGame()">
                    <option value="Daily">‚≠ê Daily Challenge</option>
                    <option id="customModeOption" value="Custom Challenge" style="display:none;">üéØ Custom Challenge</option>
                    <option value="General">General</option>
                    <option value="Science">Science</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Biology">Biology</option>
                    <option value="Zoology">Zoology</option>
                    <option value="Astronomy">Astronomy</option>
                    <option value="History">History</option>
                    <option value="Music">Music Tech</option>
                    <option value="Maths">Maths / JEE</option>
                    <option value="Geopolitics">Geopolitics</option>
                </select>
            </div>

            <div class="settings-row">
                <span class="settings-label">5-Min Countdown Timer</span>
                <label class="toggle-label"><input type="checkbox" id="countdownToggle" onchange="toggleCountdown(); triggerFeedback('ui-click');"> Enable</label>
            </div>
            
            <div class="settings-row">
                <span class="settings-label">Visual Theme</span>
                <select id="themeSelect" onchange="triggerFeedback('ui-click'); changeTheme()">
                    <option value="default">üåô Space</option>
                    <option value="mars" id="marsOption">üîí Mars (Lvl 2)</option>
                    <option value="hacker" id="hackerOption">üîí Hacker (Lvl 3)</option>
                </select>
            </div>
            
            <div class="settings-row">
                <span class="settings-label">High Contrast</span>
                <label class="toggle-label"><input type="checkbox" id="contrastToggle" onchange="toggleContrast(); triggerFeedback('ui-click');"> Enable</label>
            </div>

            <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); toggleModal('settingsModal')" style="margin-top:20px; width: 100%; border-radius:8px;">Close</button>
        </div>
    </div>

    <div id="pauseModal" class="modal" onclick="togglePause()">
        <div class="modal-content" style="text-align: center;" onclick="event.stopPropagation()">
            <h3 style="margin-top: 0; letter-spacing: 2px;">GAME PAUSED</h3>
            <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 25px;">
                <button class="action-btn btn-neutral" onclick="togglePause()" style="padding: 15px; font-size: 1.1rem; border-radius:8px;">‚ñ∂Ô∏è Resume</button>
                <button class="action-btn btn-neutral" onclick="pauseToHome()" style="padding: 15px; font-size: 1.1rem; border-radius:8px;">üè† Back to Menu</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="triggerFeedback('ui-click'); toggleModal('helpModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">How To Play</h3><p>Guess the word in exactly 6 tries. The category determines the theme!</p>
            <hr style="border: 0.5px solid var(--border)">
            <div class="example-row"><div class="mini-tile correct" style="color:#fff; border-color:var(--correct);">W</div> ORLD ‚Äî <b>Correct:</b> Right letter, right spot.</div>
            <div class="example-row"><div class="mini-tile present" style="color:#fff; border-color:var(--present);">L</div> IGHT ‚Äî <b>Present:</b> Right letter, wrong spot.</div>
            <div class="example-row"><div class="mini-tile absent" style="color:var(--text); opacity:0.6; border-color:var(--border); background:rgba(0,0,0,0.8);">G</div> HOST ‚Äî <b>Absent:</b> Not in the word.</div>
            <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); toggleModal('helpModal')" style="margin-top:15px; width: 100%; border-radius:8px;">Close</button>
        </div>
    </div>

    <div id="statsModal" class="modal" onclick="triggerFeedback('ui-click'); toggleModal('statsModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            
            <div class="level-header">
                <h3 style="margin: 0; font-size: 1.5rem; color: var(--present);" id="player-level-title">LEVEL 1</h3>
                <div class="xp-bar-container">
                    <div id="xp-bar-fill" class="xp-bar-fill" style="width: 0%;"></div>
                </div>
                <div class="xp-text" id="xp-text-detail">0 / 50 XP</div>
            </div>

            <h4 style="margin-top: 20px; margin-bottom: 10px; text-align: center; letter-spacing: 1px;">STATISTICS</h4>
            <div class="stat-container">
                <div class="stat-box"><span class="stat-num" id="stat-played">0</span><span class="stat-label">Played</span></div>
                <div class="stat-box"><span class="stat-num" id="stat-winpct">0</span><span class="stat-label">Win %</span></div>
                <div class="stat-box"><span class="stat-num" id="stat-streak" style="color: var(--correct);">0</span><span class="stat-label">üî• Streak</span></div>
                <div class="stat-box"><span class="stat-num" id="stat-maxstreak">0</span><span class="stat-label">üëë Best</span></div>
            </div>
            
            <h4 style="margin-top: 25px; margin-bottom: 10px; text-align: center; letter-spacing: 1px;">GUESS DISTRIBUTION</h4>
            <div id="guess-distribution"></div>

            <h4 style="margin-top: 30px; margin-bottom: 5px; text-align: center; letter-spacing: 1px; color: var(--present);">ACHIEVEMENTS</h4>
            <div id="badges-container" class="badges-container"></div>

            <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); toggleModal('statsModal')" style="margin-top:20px; width: 100%; border-radius:8px;">Close</button>
        </div>
    </div>

    <div id="dictModal" class="modal" onclick="triggerFeedback('ui-click'); toggleModal('dictModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="text-align: center; margin-top: 0;">CATEGORY EXAMPLES</h3>
            <p style="font-size: 0.85rem; opacity:0.7; text-align: center; margin-top: -10px;">A sneak peek at the types of words in each subject!</p>
            <div class="dict-list">
                <p><b>üåç General:</b> SMART, BOARD, CLOCK...</p>
                <p><b>üî≠ Science:</b> ATOMS, FORCE, LASER...</p>
                <p><b>üß™ Chemistry:</b> AMINE, OZONE, MOLAR...</p>
                <p><b>üß¨ Biology:</b> CELLS, BRAIN, VIRUS...</p>
                <p><b>ü¶Å Zoology:</b> TIGER, WHALE, EAGLE...</p>
                <p><b>ü™ê Astronomy:</b> MARS, COMET, ORBIT...</p>
                <p><b>üèõÔ∏è History:</b> INDUS, RUINS, MYTHS...</p>
                <p><b>üéµ Music Tech:</b> AUDIO, MIXER, TEMPO...</p>
                <p><b>‚ûó Maths / JEE:</b> GRAPH, SLOPE, AXIOM...</p>
                <p><b>üåê Geopolitics:</b> TRADE, ALLYS, PEACE...</p>
            </div>
            <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); toggleModal('dictModal')" style="margin-top:20px; width: 100%; border-radius:8px;">Close</button>
        </div>
    </div>

    <div id="appShareModal" class="modal" onclick="triggerFeedback('ui-click'); toggleModal('appShareModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="text-align: center; margin-top: 0; letter-spacing: 1px;">SHARE & DOWNLOAD</h3>
            <div style="margin: 25px 0;">
                <label style="font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">1. Share Game Link</label>
                <div style="display: flex; gap: 10px; margin-top: 8px;">
                    <input type="text" id="gameLinkInput" readonly style="flex: 1; padding: 10px; background: rgba(0,0,0,0.5); color: var(--present); border: 1px solid var(--border); border-radius: 25px; font-size: 0.9rem;">
                    <button class="action-btn btn-share" onclick="triggerFeedback('ui-click'); copyGameLink()">Copy</button>
                </div>
            </div>
            <hr style="border: 0.5px solid var(--border); margin: 20px 0;">
            <div style="text-align: center; margin-bottom: 10px;">
                <label style="font-size: 0.8rem; font-weight: bold; text-transform: uppercase; display: block; text-align: left; margin-bottom: 8px;">2. Download to Device</label>
                <button class="action-btn btn-download" style="width: 100%; padding: 12px; font-size: 1rem;" onclick="triggerFeedback('ui-click'); downloadGameOffline()">üíæ Download Offline Game</button>
            </div>
            <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); toggleModal('appShareModal')" style="margin-top:15px; width: 100%; border-radius:8px;">Close</button>
        </div>
    </div>

    <div id="timeHintModal" class="modal" onclick="triggerFeedback('ui-click'); toggleModal('timeHintModal')">
        <div class="modal-content" style="text-align: center;" onclick="event.stopPropagation()">
            <h3 style="margin-top: 0;">Need a hand? ‚è±Ô∏è</h3>
            <p style="opacity: 0.7;">You've been thinking for a while! Would you like me to reveal the first letter?</p>
            <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: center;">
                <button class="action-btn btn-share" onclick="triggerFeedback('ui-click'); acceptTimeHint()">Yes, please!</button>
                <button class="action-btn btn-neutral" onclick="triggerFeedback('ui-click'); toggleModal('timeHintModal')">No, I got this</button>
            </div>
        </div>
    </div>

    <script>
        // --- DYNAMIC BACKGROUND CANVAS LOGIC ---
        const bgCanvas = document.getElementById('theme-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        let bgAnimationId;
        let bgParticles = [];
        let matrixColumns = [];

        function resizeCanvas() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function startSpaceTheme() {
            bgParticles = [];
            for(let i=0; i<150; i++) {
                bgParticles.push({
                    x: Math.random() * bgCanvas.width,
                    y: Math.random() * bgCanvas.height,
                    r: Math.random() * 1.5,
                    dx: (Math.random() - 0.5) * 0.2,
                    dy: (Math.random() - 0.5) * 0.2
                });
            }
            
            function drawSpace() {
                bgCtx.fillStyle = '#121213';
                bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
                bgCtx.fillStyle = '#ffffff';
                
                bgParticles.forEach(p => {
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                    bgCtx.fill();
                    p.x += p.dx; p.y += p.dy;
                    if(p.x < 0) p.x = bgCanvas.width; if(p.x > bgCanvas.width) p.x = 0;
                    if(p.y < 0) p.y = bgCanvas.height; if(p.y > bgCanvas.height) p.y = 0;
                });
                
                if(Math.random() > 0.995) {
                    bgCtx.beginPath();
                    let cx = Math.random() * bgCanvas.width;
                    let cy = Math.random() * bgCanvas.height / 2;
                    bgCtx.moveTo(cx, cy);
                    bgCtx.lineTo(cx - 50, cy - 50);
                    bgCtx.strokeStyle = 'rgba(255,255,255,0.8)';
                    bgCtx.lineWidth = 2;
                    bgCtx.stroke();
                }
                bgAnimationId = requestAnimationFrame(drawSpace);
            }
            drawSpace();
        }

        function startHackerTheme() {
            const fontSize = 16;
            const colCount = Math.floor(bgCanvas.width / fontSize) + 1;
            matrixColumns = [];
            for(let i=0; i<colCount; i++) matrixColumns[i] = Math.random() * -100;
            
            function drawHacker() {
                bgCtx.fillStyle = 'rgba(5, 10, 5, 0.08)';
                bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
                bgCtx.fillStyle = '#00cc00';
                bgCtx.font = fontSize + 'px monospace';
                
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*';
                for(let i=0; i<matrixColumns.length; i++) {
                    const text = chars.charAt(Math.floor(Math.random() * chars.length));
                    bgCtx.fillText(text, i * fontSize, matrixColumns[i] * fontSize);
                    
                    if (matrixColumns[i] * fontSize > bgCanvas.height && Math.random() > 0.975) {
                        matrixColumns[i] = 0;
                    }
                    matrixColumns[i] += 0.8;
                }
                bgAnimationId = requestAnimationFrame(drawHacker);
            }
            drawHacker();
        }

        function startMarsTheme() {
            bgParticles = [];
            for(let i=0; i<120; i++) {
                bgParticles.push({
                    x: Math.random() * bgCanvas.width,
                    y: Math.random() * bgCanvas.height,
                    r: Math.random() * 3 + 1,
                    dx: Math.random() * 3 + 0.5, 
                    dy: (Math.random() - 0.5) * 1
                });
            }

            function drawMars() {
                let grad = bgCtx.createLinearGradient(0, 0, 0, bgCanvas.height);
                grad.addColorStop(0, '#260e0a');
                grad.addColorStop(1, '#592518');
                bgCtx.fillStyle = grad;
                bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

                bgCtx.fillStyle = '#150604';
                bgCtx.beginPath();
                bgCtx.moveTo(0, bgCanvas.height);
                bgCtx.lineTo(0, bgCanvas.height - 50);
                bgCtx.lineTo(bgCanvas.width * 0.3, bgCanvas.height - 120);
                bgCtx.lineTo(bgCanvas.width * 0.7, bgCanvas.height - 70);
                bgCtx.lineTo(bgCanvas.width, bgCanvas.height - 150);
                bgCtx.lineTo(bgCanvas.width, bgCanvas.height);
                bgCtx.fill();

                bgCtx.fillStyle = 'rgba(217, 75, 32, 0.3)';
                bgParticles.forEach(p => {
                    bgCtx.beginPath();
                    bgCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                    bgCtx.fill();
                    p.x += p.dx; p.y += p.dy;
                    if(p.x > bgCanvas.width) { p.x = -10; p.y = Math.random() * bgCanvas.height; }
                });

                bgAnimationId = requestAnimationFrame(drawMars);
            }
            drawMars();
        }

        function checkThemeLocks() {
            const marsOpt = document.getElementById('marsOption');
            const hackerOpt = document.getElementById('hackerOption');
            const themeSelect = document.getElementById('themeSelect');
            
            if(stats.level >= 2) {
                marsOpt.text = "ü™ê Mars";
                marsOpt.disabled = false;
            } else {
                marsOpt.text = "üîí Mars (Lvl 2)";
                marsOpt.disabled = true;
                if(themeSelect.value === 'mars') themeSelect.value = 'default';
            }

            if(stats.level >= 3) {
                hackerOpt.text = "üíª Hacker";
                hackerOpt.disabled = false;
            } else {
                hackerOpt.text = "üîí Hacker (Lvl 3)";
                hackerOpt.disabled = true;
                if(themeSelect.value === 'hacker') themeSelect.value = 'default';
            }
        }

        function openSettings() {
            checkThemeLocks();
            toggleModal('settingsModal');
        }

        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            const metaTheme = document.getElementById('theme-color-meta');
            document.body.classList.remove('theme-mars', 'theme-hacker');
            
            cancelAnimationFrame(bgAnimationId);

            if (theme === 'mars') {
                document.body.classList.add('theme-mars');
                metaTheme.content = '#260e0a';
                startMarsTheme();
            } else if (theme === 'hacker') {
                document.body.classList.add('theme-hacker');
                metaTheme.content = '#050a05';
                startHackerTheme();
            } else {
                metaTheme.content = '#121213';
                startSpaceTheme();
            }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMuted = false;

        function toggleMute() {
            isMuted = !isMuted;
            const mainBtn = document.getElementById('muteBtn');
            const tutBtn = document.getElementById('tutMuteBtn');
            if (mainBtn) mainBtn.textContent = isMuted ? "üîá" : "üîä";
            if (tutBtn) tutBtn.textContent = isMuted ? "üîá" : "üîä";
            if (!isMuted) triggerFeedback('ui-click'); 
        }

        function playSound(type) {
            if (isMuted) return; 
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            gainNode.gain.setValueAtTime(0, now);
            
            if (type === 'tap') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(350, now);
                oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.1);
                gainNode.gain.linearRampToValueAtTime(0.1, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                oscillator.start(now);
                oscillator.stop(now + 0.1);
            } else if (type === 'hover') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(700, now);
                gainNode.gain.linearRampToValueAtTime(0.015, now + 0.01); 
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                oscillator.start(now);
                oscillator.stop(now + 0.1);
            } else if (type === 'ui-click') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(400, now);
                oscillator.frequency.exponentialRampToValueAtTime(100, now + 0.04);
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.02, now + 0.005); 
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.04);
                oscillator.start(now);
                oscillator.stop(now + 0.04);
            } else if (type === 'error') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(180, now);
                oscillator.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                gainNode.gain.linearRampToValueAtTime(0.15, now + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            } else if (type === 'win') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, now);       
                oscillator.frequency.setValueAtTime(659.25, now + 0.1); 
                oscillator.frequency.setValueAtTime(783.99, now + 0.2); 
                oscillator.frequency.setValueAtTime(1046.50, now + 0.3); 
                gainNode.gain.linearRampToValueAtTime(0.1, now + 0.02);
                gainNode.gain.linearRampToValueAtTime(0.0, now + 0.7);
                oscillator.start(now);
                oscillator.stop(now + 0.7);
            }
        }

        function triggerFeedback(type) {
            playSound(type);
            if (!('vibrate' in navigator) || isMuted) return;
            if (type === 'tap' || type === 'ui-click') navigator.vibrate(15);
            else if (type === 'error') navigator.vibrate([30, 50, 30]);
            else if (type === 'win') navigator.vibrate([50, 100, 50, 100, 50]); 
        }

        function flashKey(keyId) {
            const keyEl = document.getElementById(`tk-${keyId}`);
            if(keyEl) {
                keyEl.classList.add('active-flash');
                setTimeout(() => keyEl.classList.remove('active-flash'), 100);
            }
        }

        let tutActive = false;
        const delay = ms => new Promise(res => setTimeout(res, ms));

        async function typeTutorialKey(char) {
            if(!tutActive) return;
            const targetKey = document.getElementById(`tut-k-${char}`);
            
            if (!targetKey || window.getComputedStyle(targetKey).display === 'none') {
                await delay(200);
                triggerFeedback('tap');
                return;
            }

            const rect = targetKey.getBoundingClientRect();
            const hand = document.getElementById('tut-hand');
            
            hand.style.top = (rect.top + 5) + 'px';
            hand.style.left = (rect.left + 5) + 'px';
            hand.style.opacity = '1';
            await delay(400);
            
            if(!tutActive) return;
            triggerFeedback('tap');
            hand.style.transform = 'scale(0.8)';
            targetKey.style.backgroundColor = 'rgba(255,255,255,0.2)';
            await delay(100);
            
            if(!tutActive) return;
            hand.style.transform = 'scale(1)';
            targetKey.style.backgroundColor = 'rgba(0,0,0,0.6)';
        }

        async function playTutorial() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            tutActive = true;
            const overlay = document.getElementById('tutorial-overlay');
            const text = document.getElementById('tut-text');
            const scene1 = document.getElementById('tut-scene-1');
            const scene2 = document.getElementById('tut-scene-2');
            const fakeBtn = document.getElementById('tut-cat-btn');
            const hand = document.getElementById('tut-hand');
            
            overlay.style.display = 'flex';
            scene1.style.display = 'flex';
            scene2.style.display = 'none';
            hand.style.opacity = '1';
            hand.style.top = '100%'; hand.style.left = '50%';
            text.innerHTML = "First, select a category...";

            for(let i=0; i<2; i++) {
                for(let j=0; j<5; j++) {
                    const t = document.getElementById(`tut-t-${i}-${j}`);
                    t.textContent = ""; t.className = "tile";
                }
            }

            if(!tutActive) return; await delay(800);

            if(!tutActive) return;
            const btnRect = fakeBtn.getBoundingClientRect();
            hand.style.top = (btnRect.top + 20) + 'px';
            hand.style.left = (btnRect.left + 50) + 'px';
            await delay(700);

            if(!tutActive) return;
            triggerFeedback('ui-click');
            hand.style.transform = 'scale(0.8)';
            fakeBtn.style.transform = 'scale(0.95)';
            fakeBtn.style.borderColor = "var(--correct)";
            await delay(200);
            hand.style.transform = 'scale(1)';
            fakeBtn.style.transform = 'scale(1)';
            await delay(500);

            if(!tutActive) return;
            scene1.style.display = 'none';
            scene2.style.display = 'flex';
            hand.style.top = '80%'; 
            text.innerHTML = "Guess the 5-letter word!<br>Let's guess 'WORDS'...";
            await delay(1200);

            const word1 = "WORDS";
            for(let i=0; i<5; i++) {
                await typeTutorialKey(word1[i]);
                if(!tutActive) return;
                document.getElementById(`tut-t-0-${i}`).textContent = word1[i];
            }

            await typeTutorialKey('ENTER');
            if(!tutActive) return;
            
            const colors1 = ['correct', 'correct', 'correct', 'present', 'absent'];
            for(let i=0; i<5; i++) {
                if(!tutActive) return;
                const t = document.getElementById(`tut-t-0-${i}`);
                t.classList.add('flip');
                triggerFeedback('tap');
                t.classList.add(colors1[i]);
                await delay(300);
            }

            if(!tutActive) return;
            text.innerHTML = "<span style='color:var(--correct)'>Green = Perfect.</span> <span style='color:var(--present)'>Yellow = Wrong spot.</span><br>Let's try 'WORLD'...";
            await delay(2500);

            const word2 = "WORLD";
            for(let i=0; i<5; i++) {
                await typeTutorialKey(word2[i]);
                if(!tutActive) return;
                document.getElementById(`tut-t-1-${i}`).textContent = word2[i];
            }

            await typeTutorialKey('ENTER');
            if(!tutActive) return;

            for(let i=0; i<5; i++) {
                if(!tutActive) return;
                const t = document.getElementById(`tut-t-1-${i}`);
                t.classList.add('flip');
                triggerFeedback('tap');
                t.classList.add('correct');
                await delay(300);
            }

            if(!tutActive) return;
            triggerFeedback('win');
            fireConfetti();
            text.innerHTML = "You Win! üéâ<br>Now it's your turn.";
            hand.style.opacity = '0';
            
            await delay(3000);
            closeTutorial();
        }

        function closeTutorial() {
            tutActive = false; 
            document.getElementById('tutorial-overlay').style.display = 'none';
        }

        const CATEGORIES = {
            "General": ["REACT", "APPLE", "SMART", "WORLD", "GHOST", "CHESS", "BOARD", "HOUSE", "WATER", "MONEY", "PAPER", "CLOCK", "TRAIN", "GLASS", "CHAIR", "TABLE", "BREAD", "RIVER", "HEART", "LIGHT", "DREAM", "PLANT", "EARTH", "NIGHT", "STORY", "GUEST", "MONTH", "POWER", "VOICE", "VIDEO", "FRAME", "BRICK", "STONE", "METAL", "SUGAR", "FRUIT", "SWEET", "SMILE", "LAUGH", "DANCE", "SLEEP", "WATCH", "DRINK", "BROWN", "BLACK", "WHITE", "GREEN", "PIECE", "CROWD", "MATCH", "SPORT", "BEACH", "OCEAN", "CLOUD", "STORM", "WINDY", "FLAME", "SMOKE", "NOISE", "QUIET", "MAGIC", "TRICK", "PRIZE", "PAINT", "BRUSH", "MUSIC", "SOUND", "TASTE", "TOUCH", "SMELL", "PHONE", "DRIVE"],
            "Science": ["ATOMS", "FORCE", "LASER", "FLUID", "SOLID", "PHASE", "LIGHT", "SOUND", "POWER", "PRISM", "OPTIC", "WAVES", "SCALE", "QUARK", "SPEED", "MASS", "DENSE", "VOLTS", "WATTS", "JOULE", "HERTZ", "SPACE", "LOGIC", "MODEL", "STUDY", "TESTS", "METER", "BOSON", "GLUON", "ORBIT", "ROTOR", "MOTOR", "GEARS", "LEVER", "PIVOT", "PULSE", "RAYON", "RESIN", "GLASS", "METAL", "ALLOY", "OZONE", "MACRO", "MICRO", "FLASK", "BEAMS", "XRAYS", "GAMMA", "SOLAR", "LUNAR", "DATA", "GRAPH", "CHART"],
            "Chemistry": ["AMINE", "AMIDE", "ESTER", "ETHER", "BONDS", "MOLAR", "IONIC", "GASES", "OZONE", "RADON", "ACIDS", "BASES", "YIELD", "ALLOY", "ANION", "ARGON", "BORON", "BUTYL", "FLASK", "LIPID", "METAL", "OXIDE", "POLAR", "RESIN", "SOLVE", "TOXIC", "VAPOR", "XENON", "VINYL", "ALKYL", "AZIDE", "BERYL", "BROMO", "CHLOR", "EPOXY", "IMINE", "LATEX", "PLANT", "PROXY", "SULFA", "TITAN", "CARBO", "SALTS", "ATOMS", "FLUID", "SOLID", "PHASE"],
            "Biology": ["CELLS", "BLOOD", "BRAIN", "HEART", "VEINS", "SKULL", "PLANT", "VIRUS", "YEAST", "FUNGI", "SPORE", "GENES", "NERVE", "ALGAE", "AORTA", "BONES", "CLONE", "FAUNA", "FLORA", "GLAND", "LIVER", "LUNGS", "ORGAN", "PETAL", "PULSE", "PUPIL", "ROOTS", "SPINE", "TRAIT", "BIOME", "CILIA", "FLUID", "GILLS", "MACRO", "MICRO", "MUCUS", "OVARY", "OVULE", "SCALE", "SHELL", "SKINS", "STEMS", "THORN", "SEEDS", "GERMS", "MOLDS", "MOTHS", "MITES", "WEEDS", "LEAFS", "FLESH"],
            "Zoology": ["TIGER", "EAGLE", "SNAKE", "SHARK", "WHALE", "BEARS", "LIONS", "FROGS", "BIRDS", "HORSE", "RHINO", "HIPPO", "MOOSE", "ZEBRA", "CAMEL", "CHIMP", "CRABS", "GOOSE", "HYENA", "LEMUR", "LLAMA", "MACAW", "PANDA", "SHEEP", "SKUNK", "SLOTH", "SNAIL", "SQUID", "SWANS", "BISON", "DINGO", "GECKO", "HERON", "KOALA", "OTTER", "PUPPY", "RAVEN", "ROBIN", "SEALS", "SLUGS", "STORK", "SWINE", "TAPIR", "TOADS", "TROUT", "VIPER", "WASPS", "WORMS", "MOUSE", "HOUND"],
            "Astronomy": ["VENUS", "MARS", "STARS", "MOONS", "SOLAR", "LUNAR", "SPACE", "ORBIT", "COMET", "ALIEN", "ASTRO", "BLACK", "HOLES", "DWARF", "FLARE", "LIGHT", "MILKY", "NOVA", "PLUTO", "PROBE", "ROVER", "TITAN", "DUSTS", "EARTH", "GLOBE", "NIGHT", "SKIES", "POLAR", "RINGS", "SHINE", "BLAZE", "GLINT", "SUNS", "ROCKS", "VOID", "WORLD", "REALM", "COMAS", "NOVAS"],
            "History": ["INDUS", "CIVIL", "RUINS", "TOMBS", "KINGS", "MYTHS", "ROMAN", "GREEK", "STONE", "TRIBE", "CRAFT", "TOOLS", "AZTEC", "CROWN", "EGYPT", "GLORY", "HONOR", "INCAS", "MAYAN", "NOBLE", "PEACE", "QUEEN", "REBEL", "ROYAL", "SWORD", "TREAT", "ARMOR", "ARROW", "FORTS", "SPEAR", "LANCE", "FLEET", "SIEGE", "SLAVE", "CHIEF", "BARON", "MANOR", "RULER", "REALM", "MARCH", "TROOP", "BOWS", "CLANS", "SHIPS", "BOATS", "GUNS", "RIFLE"],
            "Music": ["AUDIO", "TRACK", "BEATS", "MIXER", "TEMPO", "CHORD", "VOCAL", "SYNTH", "SOUND", "VINYL", "TUNES", "BANJO", "BASS", "BRASS", "CELLO", "CHOIR", "DANCE", "FLUTE", "LYRIC", "PIANO", "RADIO", "SONGS", "STAGE", "STRUM", "WALTZ", "BLUES", "CLEFS", "NOTES", "PITCH", "SCALE", "SNARE", "HORNS", "REEDS", "BANDS", "CHANT", "OPERA", "VOICE", "ALBUM", "DRUMS", "HARPS", "CHIME", "BELLS", "LUTES"],
            "Maths": ["GRAPH", "CURVE", "SLOPE", "RATIO", "AXIOM", "PROVE", "EQUAL", "LIMIT", "ANGLE", "DIGIT", "PRIME", "ARRAY", "CUBES", "EXACT", "INDEX", "LOGIC", "MINUS", "MODEL", "POINT", "SCALE", "SOLVE", "STATS", "TALLY", "TORUS", "VALID", "VALUE", "MATHS", "ROOTS", "SINES", "CONES", "LINES", "PLANE", "SHAPE", "WIDTH", "DEPTH", "RULES", "TERMS", "PROOF", "POLAR", "RADII", "LOCUS", "TENS", "ONES", "ZEROS", "SIGNS", "PLUS", "ADDED", "TOTAL"],
            "Geopolitics": ["TRADE", "POWER", "TREAT", "ALLYS", "ASIAN", "STATE", "WORLD", "NAVAL", "PEACE", "CLASH", "SPIES", "ALARM", "ASSET", "BOMBS", "CIVIL", "CLAIM", "COURT", "CRASH", "CROWN", "DRAFT", "ELITE", "ENEMY", "FORCE", "FORUM", "GUARD", "UNION", "VOTER", "ALLY", "BLOCK", "BRIBE", "CABAL", "CHIEF", "CUBAN", "DEALS", "FLEET", "FRAUD", "FUNDS", "JUNTA", "MAYOR", "MEDIA", "MONEY", "PACT", "PARTY", "PRESS", "REBEL", "RIGHT", "RIVAL", "RULER", "SEALS", "SIEGE", "SMUG", "TAXES", "TROOP", "TRUST", "UNITE"]
        };

        const COMMON_WORDS_STRING = "ABOUT,ABOVE,ACTOR,ACUTE,ADAPT,ADMIT,ADOPT,ADULT,AFTER,AGAIN,AGENT,AGREE,AHEAD,ALARM,ALBUM,ALERT,ALIEN,ALIGN,ALIKE,ALIVE,ALLOW,ALONE,ALONG,ALTER,AMONG,ANGER,ANGLE,ANGRY,APPLE,APPLY,ARENA,ARGUE,ARISE,ARRAY,ARROW,ASIAN,ASIDE,ASSET,AUDIO,AUDIT,AVOID,AWAKE,AWARD,AWARE,BACON,BAKER,BASIC,BASIN,BASIS,BATCH,BEACH,BEARD,BEAST,BEGIN,BEING,BELOW,BENCH,BILLY,BIRTH,BLACK,BLADE,BLAME,BLANK,BLIND,BLOCK,BOARD,BOAST,BONUS,BOOST,BOOTH,BOUND,BRAIN,BRAKE,BRAND,BREAD,BREAK,BREED,BRICK,BRIDE,BRIEF,BRING,BROAD,BROKE,BROWN,BRUSH,BUILD,BUILT,BUYER,CABIN,CABLE,CATCH,CAUSE,CHAIN,CHAIR,CHART,CHASE,CHEAP,CHECK,CHEEK,CHEER,CHESS,CHEST,CHIEF,CHILD,CHINA,CHOIR,CHOSE,CIVIC,CIVIL,CLAIM,CLASS,CLEAN,CLEAR,CLERK,CLICK,CLOCK,CLOSE,COACH,COAST,COLON,COLOR,COMIC,CORAL,COTTON,COUCH,COULD,COUNT,COURT,COVER,CRACK,CRAFT,CRAZY,CREAM,CROSS,CROWD,CROWN,CURVE,CYCLE,DAILY,DANCE,DATED,DEALT,DEBUT,DELAY,DEPTH,DIARY,DIGIT,DISCO,DITCH,DONOR,DOUBT,DRAFT,DRAMA,DRAWN,DREAM,DRESS,DRILL,DRINK,DRIVE,EAGER,EAGLE,EARLY,EARTH,EIGHT,ELITE,EMPTY,ENJOY,ENTER,ENTRY,EQUAL,ERROR,ESSAY,EVENT,EVERY,EXACT,EXIST,EXTRA,FAITH,FALSE,FAULT,FIBER,FIELD,FIFTH,FIFTY,FIGHT,FINAL,FIRST,FIXED,FLASH,FLEET,FLIGHT,FLOOR,FLOUR,FLUID,FOCUS,FORCE,FORTH,FORTY,FORUM,FOUND,FRAME,FRESH,FRONT,FRUIT,FULLY,FUNNY,GIANT,GIVEN,GLASS,GLOBE,GLORY,GOING,GRACE,GRADE,GRAND,GRANT,GRASS,GREAT,GREEN,GROSS,GROUP,GROWN,GUARD,GUESS,GUEST,GUIDE,HABIT,HAPPY,HARSH,HEART,HEAVY,HELLO,HENCE,HORSE,HOTEL,HOUSE,HUMAN,IDEAL,IMAGE,INDEX,INNER,INPUT,ISSUE,JOINT,JUDGE,JUICE,KNOWN,LABEL,LABOR,LARGE,LATER,LAUGH,LAYER,LEARN,LEASE,LEAST,LEAVE,LEGAL,LEMON,LEVEL,LIGHT,LIMIT,LINEN,LOCAL,LOGIC,LOOSE,LOWER,LUCKY,LUNCH,MAGIC,MAJOR,MAKER,MARCH,MARRY,MATCH,MAYBE,MAYOR,MEANT,MEDIA,MERIT,METAL,METER,MIGHT,MINOR,MINUS,MIXED,MODEL,MONEY,MONTH,MORAL,MOTOR,MOUNT,MOUSE,MOUTH,MOVIE,MUSIC,NEEDS,NEVER,NEWLY,NIGHT,NOISE,NORTH,NOVEL,NURSE,OCCUR,OCEAN,OFFER,OFTEN,ONION,ORDER,ORGAN,OTHER,OUGHT,OUNCE,OUTER,OWNER,PANEL,PAPER,PARTY,PATCH,PEACE,PHASE,PHONE,PHOTO,PIANO,PIECE,PILOT,PITCH,PLACE,PLAIN,PLANE,PLANT,PLATE,POINT,POUND,POWER,PRESS,PRICE,PRIDE,PRIME,PRINT,PRIOR,PRIZE,PROOF,PROUD,PROVE,QUEEN,QUICK,QUIET,QUITE,RADIO,RAISE,RANGE,RAPID,RATIO,REACH,REACT,READY,REALM,REBEL,REFER,RELAX,RELAY,REPLY,RIGHT,RIVER,ROMAN,ROUGH,ROUND,ROUTE,ROYAL,RURAL,SCALE,SCENE,SCOPE,SCORE,SENSE,SERVE,SETUP,SEVEN,SHALL,SHAPE,SHARE,SHARP,SHEET,SHELF,SHELL,SHIFT,SHIRT,SHOCK,SHOOT,SHORT,SHOWN,SIGHT,SINCE,SIXTH,SIXTY,SKILL,SLEEP,SLIDE,SMALL,SMART,SMILE,SMITH,SMOKE,SOLID,SOLVE,SORRY,SOUND,SOUTH,SPACE,SPARE,SPEAK,SPEED,SPELL,SPEND,SPENT,SPLIT,SPOKE,SPORT,STAFF,STAGE,STAND,START,STATE,STEAM,STEEL,STICK,STILL,STOCK,STONE,STOOD,STORE,STORM,STORY,STRIP,STUCK,STUDY,STUFF,STYLE,SUGAR,SUPER,SWEET,TABLE,TAKEN,TASTE,TAXES,TEACH,TEETH,TENTH,TEXAS,THANK,THEIR,THEME,THERE,THESE,THICK,THING,THINK,THIRD,THOSE,THREE,THREW,THROW,TIGER,TIGHT,TIMES,TITLE,TODAY,TOPIC,TOTAL,TOUCH,TOUGH,TOWER,TRACK,TRADE,TRAIN,TREAT,TREND,TRIAL,TRIBE,TRICK,TRUCK,TRULY,TRUST,TRUTH,TWICE,UNDER,UNION,UNITY,UNTIL,UPPER,UPSET,URBAN,USAGE,USUAL,VALID,VALUE,VIDEO,VIRUS,VISIT,VITAL,VOICE,VOTER,WAGON,WASTE,WATCH,WATER,WHEEL,WHERE,WHICH,WHILE,WHITE,WHOLE,WHOSE,WOMAN,WOMEN,WORDS,WORLD,WORRY,WORSE,WORST,WORTH,WOULD,WOUND,WRITE,WRONG,YIELD,YOUNG,YOUTH,AISLE,BINGO,BLAST,BULLY,CARGO,CHALK,CHOKE,CRISP,CURLY,DAISY,DART,DECAL,DEMON,DIZZY,DUMMY,DWARF,FABLE,FANCY,FEAST,FENCE,FETCH,FEVER,FLAKE,FLOCK,FLUFF,FROST,GLIDE,GRILL,HAIRY,HATCH,HOVER,HURRY,ITCHY,JELLY,JUMBO,KNOCK,LEAKY,LEAP,LOVER,LUNGE,MADAM,MAMMA,MIMIC,MOIST,MUMMY,NASTY,NINJA,ONION,OVAL,PADDY,PANSY,PASTA,PEARL,PEDAL,PENNY,PESTS,PIZZA,PLUMP,POUCH,PROWL,PUPPY,QUACK,QUERY,RADAR,RASPY,RAZOR,RHYME,ROAST,ROBOT,RUMOR,SALAD,SALSA,SAUCE,SCOLD,SCOOP,SCRAP,SHADY,SHAKE,SHINE,SHIRT,SHOVE,SHRUB,SHRUG,SKATE,SKULL,SLANG,SLASH,SLATE,SMASH,SNAIL,SNAKE,SNEAK,SNIFF,SNOWY,SPICE,SPICY,SPIKE,SPILL,SPINE,SPLAT,SPOON,SPOUT,SPRAY,SPURT,SQUAD,SQUAT,STAIN,STAMP,STARE,STEEP,STERN,STING,STOOL,STRAP,STRAW,STUMP,SWAMP,SWARM,SWEAT,SWELL,SWIFT,SWIPE,SWIRL,SWOOP,SYRUP,TABOO,TAFFY,TAINT,TALLY,TALON,TAMER,TANGO,TAPER,TAROT,TASTE,TASTY,TAUNT,TEASE,TEMPO,TENOR,THUMB,UMPIR,UNCLE,UNZIP,VAGUE,VALET,VENOM,VERGE,VIGOR,VILLA,VOCAL,VOGUE,WACKY,WAFER,WALTZ,WASTE,WEAVE,WEIRD,WHEAT,WHIFF,WHISK,WHISPER,WIDOW,WINCE,WINDY,WIPER,WITCH,WRIST,YACHT,YEARN,YOUTH,ZEBRA,ZIPPY";
        
        const VALID_GUESSES = [...new Set([...Object.values(CATEGORIES).flat(), ...COMMON_WORDS_STRING.split(",")])];

        let currentCategory = "General";
        let isCountdown = false; 
        let targetWord = "";
        let currentRow = 0, currentCol = 0, gameOver = false, startTime, timerInt;
        let guesses = Array(6).fill("");
        let boardEmoji = [];
        let letterStates = {}; 
        let timeHintOffered = false;
        let isPaused = false;
        let pauseStartTime = 0;
        let finalTimeStr = "00:00";
        
        let stats = JSON.parse(localStorage.getItem('syllabix-stats-v2')) || { played: 0, won: 0, currentStreak: 0, maxStreak: 0, guesses: {1:0, 2:0, 3:0, 4:0, 5:0, 6:0} };
        if (!stats.daily) stats.daily = { date: "", status: "", attempts: 0, word: "" };
        if (!stats.badges) stats.badges = { speed_demon: false, clutch: false, brainiac: false, night_owl: false, daily_master: false };
        
        // --- NEW: INITIALIZE XP TRACKER ---
        if (typeof stats.xp === 'undefined') stats.xp = 0;
        if (typeof stats.level === 'undefined') stats.level = 1;

        window.addEventListener('load', () => {
            startSpaceTheme(); 
            initBoardAndKeyboard(); 
            
            const urlParams = new URLSearchParams(window.location.search);
            const challenge = urlParams.get('challenge');
            
            const splash = document.getElementById('splash-screen');
            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => { 
                    splash.style.display = 'none'; 
                    
                    if(challenge) {
                        try {
                            const decodedWord = atob(challenge);
                            if(decodedWord.length === 5 && /^[A-Z]+$/.test(decodedWord)) {
                                startChallengeMode(decodedWord);
                            }
                        } catch(e) { console.log("Invalid challenge link"); }
                    }
                }, 600);
            }, 2500);
        });

        window.addEventListener('beforeunload', function (e) {
            if ((currentRow > 0 || currentCol > 0) && !gameOver) {
                e.preventDefault(); e.returnValue = '';
            }
        });

        function createChallengeLink() {
            let word = prompt("Enter a 5-letter word to challenge your friends:");
            if(word) {
                word = word.toUpperCase().trim();
                if(word.length === 5 && /^[A-Z]+$/.test(word)) {
                    const encoded = btoa(word);
                    let currentUrl = window.location.href.split('?')[0];
                    const finalLink = `${currentUrl}?challenge=${encoded}`;
                    
                    const tempInput = document.createElement("input");
                    tempInput.value = finalLink;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    
                    alert("Link Copied! Send it to a friend and they will be forced to guess: " + word);
                } else {
                    alert("Word must be exactly 5 letters containing only English alphabets.");
                }
            }
        }

        function startChallengeMode(word) {
            targetWord = word;
            currentCategory = "Custom Challenge";
            const catSelect = document.getElementById('categorySelect');
            document.getElementById('customModeOption').style.display = "block";
            catSelect.value = "Custom Challenge";
            
            const catScreen = document.getElementById('category-screen');
            catScreen.style.display = 'none';
            resetGame(true); 
            showMsg("üéØ You've been challenged! Guess the secret word.");
        }


        function checkDailyLock() {
            const today = new Date().toLocaleDateString();
            return (stats.daily && stats.daily.date === today && stats.daily.status !== "");
        }

        let dailyCountdownInt;
        function showDailyLock() {
            const msgEl = document.getElementById('dailyLockMessage');
            if (stats.daily.status === 'won') {
                msgEl.innerHTML = `You solved today's word in <b style="color:var(--correct)">${stats.daily.attempts}</b> attempts!<br>Come back tomorrow.`;
            } else if (stats.daily.status === 'gave_up') {
                msgEl.innerHTML = `You gave up today.<br>The word was <b style="color:var(--present)">${stats.daily.word}</b>.<br>Come back tomorrow.`;
            } else if (stats.daily.status === 'time_up') {
                msgEl.innerHTML = `You ran out of time today.<br>The word was <b style="color:var(--present)">${stats.daily.word}</b>.<br>Come back tomorrow.`;
            } else {
                msgEl.innerHTML = `You ran out of attempts.<br>The word was <b style="color:var(--present)">${stats.daily.word}</b>.<br>Come back tomorrow.`;
            }
            
            startDailyCountdown();
            document.getElementById('dailyLockModal').style.display = 'flex';
        }

        function startDailyCountdown() {
            if (dailyCountdownInt) clearInterval(dailyCountdownInt);
            const updateTimer = () => {
                const now = new Date();
                const midnight = new Date(now);
                midnight.setHours(24, 0, 0, 0); 
                const diff = midnight - now;

                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                const s = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');

                document.getElementById('dailyCountdown').textContent = `${h}:${m}:${s}`;
            };
            updateTimer();
            dailyCountdownInt = setInterval(updateTimer, 1000);
        }

        function closeDailyLock() {
            if (dailyCountdownInt) clearInterval(dailyCountdownInt);
            document.getElementById('dailyLockModal').style.display = 'none';
            if (document.getElementById('categorySelect').value === 'Daily') {
                document.getElementById('categorySelect').value = currentCategory === 'Daily' ? 'General' : currentCategory;
            }
        }

        function togglePause() {
            if(gameOver || document.getElementById('category-screen').style.display !== 'none') return;
            
            isPaused = !isPaused;
            if(isPaused) {
                pauseStartTime = Date.now();
                document.getElementById('pauseModal').style.display = 'flex';
            } else {
                startTime += (Date.now() - pauseStartTime);
                document.getElementById('pauseModal').style.display = 'none';
            }
            triggerFeedback('ui-click');
        }

        function pauseToHome() {
            isPaused = false;
            document.getElementById('pauseModal').style.display = 'none';
            triggerFeedback('ui-click');
            
            if(currentCategory === "Custom Challenge") {
                window.history.pushState({}, document.title, window.location.pathname);
            }
            returnToMenu();
        }

        function startGame(category) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            if (category === 'Daily' && checkDailyLock()) {
                showDailyLock();
                return;
            }

            if(category !== 'Custom Challenge') {
                document.getElementById('customModeOption').style.display = "none";
                window.history.pushState({}, document.title, window.location.pathname);
            }

            currentCategory = category;
            document.getElementById('categorySelect').value = category; 
            const catScreen = document.getElementById('category-screen');
            catScreen.style.opacity = '0';
            catScreen.style.transform = 'translateY(-20px)';
            setTimeout(() => { catScreen.style.display = 'none'; }, 500);
            resetGame(); 
        }

        function changeCategoryMidGame() {
            const newCat = document.getElementById('categorySelect').value;
            if (newCat === 'Daily' && checkDailyLock()) {
                showDailyLock();
                return; 
            }
            
            if(newCat !== 'Custom Challenge') {
                document.getElementById('customModeOption').style.display = "none";
                window.history.pushState({}, document.title, window.location.pathname);
            }

            currentCategory = newCat;
            resetGame(); 
            showMsg(`Subject changed to: ${currentCategory}`);
            setTimeout(() => { if(document.getElementById('message').textContent.includes('Subject')) showMsg(""); }, 2000);
        }

        function toggleCountdown() {
            const willBeCountdown = document.getElementById('countdownToggle').checked;
            
            if (currentCategory === 'Daily' && (currentRow > 0 || currentCol > 0) && !gameOver) {
                showMsg("Can't change timer mid-game!");
                document.getElementById('countdownToggle').checked = isCountdown;
                return;
            }
            
            isCountdown = willBeCountdown;
            resetGame(currentCategory === "Custom Challenge"); 
            showMsg(isCountdown ? `Timer set to: 5 Min Countdown` : `Timer set to: Count Up`);
            setTimeout(() => { if(document.getElementById('message').textContent.includes('Timer')) showMsg(""); }, 2000);
        }

        function returnToMenu() {
            clearInterval(timerInt); 
            const catScreen = document.getElementById('category-screen');
            catScreen.style.display = 'flex';
            setTimeout(() => { 
                catScreen.style.opacity = '1'; 
                catScreen.style.transform = 'translateY(0)';
            }, 50);
        }

        function initBoardAndKeyboard() {
            const container = document.getElementById('game-container');
            container.innerHTML = ''; 
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('div'); row.className = 'row';
                for (let j = 0; j < 5; j++) {
                    const tile = document.createElement('div'); tile.className = 'tile';
                    tile.id = `tile-${i}-${j}`; row.appendChild(tile);
                }
                container.appendChild(row);
            }

            const tracker = document.getElementById('tracker-keyboard');
            tracker.innerHTML = '';
            
            const QWERTY = [
                ["Q","W","E","R","T","Y","U","I","O","P"],
                ["A","S","D","F","G","H","J","K","L"],
                ["ENTER","Z","X","C","V","B","N","M","‚å´"]
            ];
            
            QWERTY.forEach((row, index) => {
                const rowEl = document.createElement('div'); rowEl.className = 'tk-row';
                if(index === 1) rowEl.style.padding = "0 5%"; 
                
                row.forEach(key => {
                    const keyEl = document.createElement('div'); keyEl.className = 'tk-key';
                    if (key === "ENTER" || key === "‚å´") keyEl.classList.add('tk-action');
                    
                    keyEl.id = `tk-${key}`; keyEl.textContent = key;
                    keyEl.addEventListener('click', () => {
                        triggerFeedback('tap');
                        if (key === "ENTER") handleInput('Enter');
                        else if (key === "‚å´") handleInput('Backspace');
                        else handleInput(key);
                    });
                    rowEl.appendChild(keyEl);
                });
                tracker.appendChild(rowEl);
            });
        }

        function startTimer() {
            if(timerInt) clearInterval(timerInt); 
            startTime = Date.now();
            
            document.getElementById('timer').style.color = '';
            
            if (isCountdown) {
                document.getElementById('timer').textContent = "05:00";
            } else {
                document.getElementById('timer').textContent = "00:00";
            }
            
            timerInt = setInterval(() => {
                if (gameOver || isPaused) return; 
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                
                if (!isCountdown) {
                    const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const s = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${m}:${s}`;
                    
                    if (elapsed >= 300 && !timeHintOffered && !gameOver) {
                        timeHintOffered = true;
                        toggleModal('timeHintModal');
                    }
                } else {
                    const remaining = 300 - elapsed;
                    
                    if (remaining <= 0) {
                        document.getElementById('timer').textContent = "00:00";
                        timeUp();
                        return;
                    }
                    
                    if (remaining <= 60) document.getElementById('timer').style.color = '#ff5252';
                    
                    const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                    const s = (remaining % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${m}:${s}`;
                    
                    if (elapsed >= 150 && !timeHintOffered && !gameOver) {
                        timeHintOffered = true;
                        toggleModal('timeHintModal');
                    }
                }
            }, 1000);
        }
        
        function freezeTime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            if (!isCountdown) {
                const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const s = (elapsed % 60).toString().padStart(2, '0');
                finalTimeStr = `${m}:${s}`;
            } else {
                const remaining = Math.max(0, 300 - elapsed);
                const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                const s = (remaining % 60).toString().padStart(2, '0');
                finalTimeStr = `${m}:${s} left`;
            }
        }

        function timeUp() {
            if(gameOver) return;
            gameOver = true;
            freezeTime();
            clearInterval(timerInt);
            triggerFeedback('error');
            showMsg(`Time's Up! Word: ${targetWord}`, true);
            if (currentCategory === "Daily") stats.daily = { date: new Date().toLocaleDateString(), status: "time_up", attempts: currentRow, word: targetWord };
            saveStats(false);
            showEndgameButtons();
        }

        function resetGame(keepTarget = false) {
            if (!keepTarget) {
                if (currentCategory === "Daily") {
                    const dailyPool = Object.values(CATEGORIES).flat();
                    const daysSinceEpoch = Math.floor(Date.now() / 86400000); 
                    targetWord = dailyPool[daysSinceEpoch % dailyPool.length];
                } else {
                    targetWord = CATEGORIES[currentCategory][Math.floor(Math.random() * CATEGORIES[currentCategory].length)]; 
                }
            }
            
            currentRow = 0; currentCol = 0; gameOver = false; guesses = Array(6).fill(""); boardEmoji = [];
            timeHintOffered = false; letterStates = {}; isPaused = false; pauseStartTime = 0;
            
            for(let i=0; i<6; i++) {
                for(let j=0; j<5; j++) {
                    const t = document.getElementById(`tile-${i}-${j}`);
                    t.textContent = ""; t.className = 'tile'; 
                }
            }
            document.querySelectorAll('.tk-key').forEach(k => {
                k.className = 'tk-key';
                if(k.id === 'tk-ENTER' || k.id === 'tk-‚å´') k.classList.add('tk-action');
            });
            
            document.getElementById('giveUpBtn').style.display = "inline-flex";
            document.getElementById('shareBtn').style.display = "none";
            document.getElementById('defineBtn').style.display = "none";
            document.getElementById('playAgainBtn').style.display = "none";
            
            if(!keepTarget) showMsg(""); 
            startTimer(); 
        }

        function handleInput(k) {
            if(gameOver || isPaused || document.getElementById('category-screen').style.display !== 'none') return;
            
            if((k === 'Backspace') && currentCol > 0) {
                currentCol--; guesses[currentRow] = guesses[currentRow].slice(0, -1);
            } else if(k === 'Enter') {
                if (currentCol === 5) submitGuess();
                else {
                    triggerFeedback('error');
                    shakeRow(); showMsg("Not enough letters");
                    setTimeout(() => { if(!gameOver && document.getElementById('message').textContent === "Not enough letters") showMsg(""); }, 1500);
                }
            } else if(/^[a-zA-Z]$/.test(k) && currentCol < 5 && k.length === 1) {
                guesses[currentRow] += k.toUpperCase(); currentCol++;
            }
            updateView();
        }

        function updateView() {
            for(let i=0; i<5; i++) {
                const t = document.getElementById(`tile-${currentRow}-${i}`);
                t.textContent = guesses[currentRow][i] || "";
            }
        }

        function updateTracker(char, status) {
            const currentStatus = letterStates[char];
            if (currentStatus === 'correct') return; 
            if (currentStatus === 'present' && status === 'absent') return;
            letterStates[char] = status;
            const keyEl = document.getElementById(`tk-${char}`);
            if (keyEl) {
                keyEl.classList.remove('tk-correct', 'tk-present', 'tk-absent');
                keyEl.classList.add(`tk-${status}`);
            }
        }

        function shakeRow() {
            const rows = document.querySelectorAll('.row');
            rows[currentRow].classList.add('shake');
            setTimeout(() => { rows[currentRow].classList.remove('shake'); }, 400); 
        }

        // --- NEW: XP ENGINE & LEVEL UP LOGIC ---
        function calculateAndAddXP(elapsedSecs) {
            if(currentCategory === "Custom Challenge") return 0; 
            
            let xpGained = 10; // Base Win
            if (currentCategory === "Daily") xpGained += 15;
            if (elapsedSecs < 60) xpGained += 5;
            
            stats.xp += xpGained;
            
            // Level Thresholds
            const lvl2Target = 50;
            const lvl3Target = 150;
            let levelUp = false;

            if (stats.level === 1 && stats.xp >= lvl2Target) { stats.level = 2; levelUp = true; }
            if (stats.level === 2 && stats.xp >= lvl3Target) { stats.level = 3; levelUp = true; }

            localStorage.setItem('syllabix-stats-v2', JSON.stringify(stats));

            return { xpGained, levelUp };
        }

        function checkAchievements(elapsedSecs) {
            if(currentCategory === "Custom Challenge") return; 
            
            let unlockedAny = false;
            let newlyUnlocked = [];

            if(!stats.badges.speed_demon && elapsedSecs < 60) {
                stats.badges.speed_demon = true; newlyUnlocked.push("Speed Demon ‚ö°"); unlockedAny = true;
            }
            if(!stats.badges.clutch && currentRow === 5) {
                stats.badges.clutch = true; newlyUnlocked.push("Clutch üò∞"); unlockedAny = true;
            }
            if(!stats.badges.brainiac && stats.currentStreak >= 2) {
                stats.badges.brainiac = true; newlyUnlocked.push("Brainiac üß†"); unlockedAny = true;
            }
            const hour = new Date().getHours();
            if(!stats.badges.night_owl && hour >= 0 && hour < 4) {
                stats.badges.night_owl = true; newlyUnlocked.push("Night Owl ü¶â"); unlockedAny = true;
            }
            if(!stats.badges.daily_master && currentCategory === "Daily") {
                stats.badges.daily_master = true; newlyUnlocked.push("Daily Master ‚≠ê"); unlockedAny = true;
            }

            if(unlockedAny) {
                setTimeout(() => { showMsg(`Unlocked: ${newlyUnlocked.join(", ")}!`); }, 2000); 
            }
        }

        async function submitGuess() {
            const guess = guesses[currentRow];
            
            if (!VALID_GUESSES.includes(guess)) {
                triggerFeedback('error');
                shakeRow(); showMsg("Not in word list");
                setTimeout(() => { if(!gameOver && document.getElementById('message').textContent === "Not in word list") showMsg(""); }, 1500);
                return; 
            }

            let rowEmoji = "";
            gameOver = true; 
            
            for(let i=0; i<5; i++) {
                const t = document.getElementById(`tile-${currentRow}-${i}`);
                const char = guess[i];
                let status = "";
                
                await new Promise(r => setTimeout(r, 150));
                t.classList.add('flip');
                triggerFeedback('tap'); 
                
                if(char === targetWord[i]) { 
                    t.classList.add('correct'); rowEmoji += document.getElementById('contrastToggle').checked ? "üüß" : "üü©"; status = "correct";
                } else if(targetWord.includes(char)) { 
                    t.classList.add('present'); rowEmoji += document.getElementById('contrastToggle').checked ? "üü¶" : "üü®"; status = "present";
                } else { 
                    t.classList.add('absent'); rowEmoji += "‚¨õ"; status = "absent";
                }
                updateTracker(char, status);
            }
            boardEmoji.push(rowEmoji);

            if(guess === targetWord) {
                freezeTime();
                clearInterval(timerInt);
                triggerFeedback('win');
                
                const elapsedSecs = Math.floor((Date.now() - startTime) / 1000);
                const { xpGained, levelUp } = calculateAndAddXP(elapsedSecs);
                checkAchievements(elapsedSecs);

                let winMsg = "Impressive! üéâ";
                if(xpGained > 0) winMsg = `Impressive! üéâ (+${xpGained} XP)`;
                showMsg(winMsg);
                
                if (levelUp) {
                    setTimeout(() => { showMsg(`LEVEL UP! You are now Level ${stats.level}! üöÄ`); triggerFeedback('win'); }, 4000);
                }

                fireConfetti();
                if (currentCategory === "Daily") stats.daily = { date: new Date().toLocaleDateString(), status: "won", attempts: currentRow + 1, word: targetWord };
                saveStats(true);
                showEndgameButtons();
            } else if(currentRow === 5) {
                freezeTime();
                clearInterval(timerInt);
                triggerFeedback('error');
                showMsg(`You used all attempts! Word: ${targetWord}`, true);
                if (currentCategory === "Daily") stats.daily = { date: new Date().toLocaleDateString(), status: "lost", attempts: 6, word: targetWord };
                saveStats(false);
                showEndgameButtons();
            } else { 
                currentRow++; currentCol = 0; gameOver = false; 
            }
        }

        function giveUpWord() {
            if(gameOver) return;
            gameOver = true;
            freezeTime();
            clearInterval(timerInt);
            triggerFeedback('error');
            showMsg(`You gave up! Word: ${targetWord}`, true);
            if (currentCategory === "Daily") stats.daily = { date: new Date().toLocaleDateString(), status: "gave_up", attempts: currentRow, word: targetWord };
            saveStats(false);
            showEndgameButtons();
        }

        function getHint() {
            if(gameOver) return;
            let foundLetters = [];
            for(let i=0; i<6; i++) {
                for(let j=0; j<5; j++) {
                    const t = document.getElementById(`tile-${i}-${j}`);
                    if(t.classList.contains('correct') || t.classList.contains('present')) foundLetters.push(t.textContent);
                }
            }
            const unrevealed = targetWord.split('').filter(l => !foundLetters.includes(l));
            if(unrevealed.length > 0) {
                const hintLetter = unrevealed[Math.floor(Math.random() * unrevealed.length)];
                showMsg(`Hint: The word contains '${hintLetter}'`);
            } else { showMsg("You already have all the letters!"); }
        }

        function acceptTimeHint() {
            toggleModal('timeHintModal');
            showMsg(`Hint: The first letter is '${targetWord[0]}'`);
            setTimeout(() => { if(!gameOver && document.getElementById('message').textContent.includes('first letter is')) showMsg(""); }, 4000);
        }

        function fireConfetti() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, zIndex: 1000 }); }

        function saveStats(won) {
            if(currentCategory === "Custom Challenge") return; 

            stats.played++;
            if (won) {
                stats.won++;
                stats.currentStreak++;
                if (stats.currentStreak > stats.maxStreak) stats.maxStreak = stats.currentStreak;
                stats.guesses[currentRow + 1]++;
            } else {
                stats.currentStreak = 0; 
            }
            localStorage.setItem('syllabix-stats-v2', JSON.stringify(stats));
        }

        function openStats() {
            // Populate XP Bar
            document.getElementById('player-level-title').textContent = `LEVEL ${stats.level}`;
            const xpText = document.getElementById('xp-text-detail');
            const xpFill = document.getElementById('xp-bar-fill');
            
            if (stats.level === 1) {
                xpText.textContent = `${stats.xp} / 50 XP`;
                xpFill.style.width = `${(stats.xp / 50) * 100}%`;
            } else if (stats.level === 2) {
                xpText.textContent = `${stats.xp} / 150 XP`;
                xpFill.style.width = `${(stats.xp / 150) * 100}%`;
            } else {
                xpText.textContent = `${stats.xp} XP (MAX LEVEL)`;
                xpFill.style.width = `100%`;
            }

            document.getElementById('stat-played').textContent = stats.played;
            document.getElementById('stat-winpct').textContent = stats.played === 0 ? 0 : Math.round((stats.won / stats.played) * 100);
            document.getElementById('stat-streak').textContent = stats.currentStreak || 0;
            document.getElementById('stat-maxstreak').textContent = stats.maxStreak || 0;

            const distContainer = document.getElementById('guess-distribution');
            distContainer.innerHTML = '';
            
            let maxGuesses = 1;
            for(let i=1; i<=6; i++) { if(stats.guesses[i] > maxGuesses) maxGuesses = stats.guesses[i]; }

            for (let i = 1; i <= 6; i++) {
                const val = stats.guesses[i];
                const widthPct = Math.max(7, (val / maxGuesses) * 100); 
                const row = document.createElement('div'); row.className = 'graph-row';
                const num = document.createElement('div'); num.className = 'graph-num'; num.textContent = i;
                const bar = document.createElement('div'); bar.className = 'graph-bar'; 
                bar.style.width = `${widthPct}%`; bar.textContent = val;
                
                if (gameOver && val > 0 && currentRow + 1 === i && guesses[currentRow] === targetWord) {
                    bar.classList.add('highlight');
                }
                row.appendChild(num); row.appendChild(bar);
                distContainer.appendChild(row);
            }

            const badgesData = [
                { id: 'speed_demon', icon: '‚ö°', name: 'Speed Demon' },
                { id: 'clutch', icon: 'üò∞', name: 'Clutch' },
                { id: 'brainiac', icon: 'üß†', name: 'Brainiac' },
                { id: 'night_owl', icon: 'ü¶â', name: 'Night Owl' },
                { id: 'daily_master', icon: '‚≠ê', name: 'Daily Master' }
            ];
            
            const badgesContainer = document.getElementById('badges-container');
            badgesContainer.innerHTML = '';
            
            badgesData.forEach(b => {
                const isUnlocked = stats.badges[b.id];
                const badgeEl = document.createElement('div');
                badgeEl.className = `badge ${isUnlocked ? 'unlocked' : ''}`;
                badgeEl.innerHTML = `
                    <div class="badge-icon" title="${b.name}">${b.icon}</div>
                    <div class="badge-name">${b.name}</div>
                `;
                badgesContainer.appendChild(badgeEl);
            });

            toggleModal('statsModal');
        }

        function toggleContrast() {
            const isContrast = document.getElementById('contrastToggle').checked;
            if(isContrast) document.body.classList.add('high-contrast');
            else document.body.classList.remove('high-contrast');
        }

        function showEndgameButtons() {
            document.getElementById('giveUpBtn').style.display = "none";
            document.getElementById('shareBtn').style.display = "inline-flex";
            document.getElementById('defineBtn').style.display = "inline-flex";
            document.getElementById('playAgainBtn').style.display = "inline-flex";
        }

        function openDictionary() {
            window.open(`https://www.merriam-webster.com/dictionary/${targetWord.toLowerCase()}`, '_blank');
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        function showMsg(m, isError = false) { 
            const msgBox = document.getElementById('message');
            msgBox.textContent = m; 
            if (isError) msgBox.classList.add('error-msg');
            else msgBox.classList.remove('error-msg');
        }

        function shareResults() {
            let timeLabel = finalTimeStr;
            if (isCountdown) timeLabel += " (Timed)";
            
            const text = `Syllabix [${currentCategory}] ${currentRow === 6 && guesses[5] !== targetWord ? 'X' : currentRow + 1}/6 ‚è±Ô∏è ${timeLabel}\n‚≠ê Level: ${stats.level}\n\n${boardEmoji.join('\n')}`;
            navigator.clipboard.writeText(text);
            showMsg("Results copied to clipboard!");
            setTimeout(() => { if(document.getElementById('message').textContent === "Results copied to clipboard!") showMsg(""); }, 2000);
        }

        function openShareAppMenu() {
            let currentUrl = window.location.href.split('?')[0];
            document.getElementById('gameLinkInput').value = currentUrl;
            toggleModal('appShareModal');
        }

        function copyGameLink() {
            const linkInput = document.getElementById('gameLinkInput');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value);
            showMsg("App link copied!");
            setTimeout(() => { if(document.getElementById('message').textContent === "App link copied!") showMsg(""); }, 2000);
        }

        function downloadGameOffline() {
            const htmlContent = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Syllabix_Game.html"; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMsg("Download started!");
            setTimeout(() => { if(document.getElementById('message').textContent === "Download started!") showMsg(""); }, 2000);
            toggleModal('appShareModal'); 
        }

        window.addEventListener('keydown', e => {
            if(e.ctrlKey || e.metaKey || e.altKey) return;
            
            let keyToFlash = null;
            if(/^[a-zA-Z]$/.test(e.key)) keyToFlash = e.key.toUpperCase();
            else if(e.key === 'Enter') keyToFlash = 'ENTER';
            else if(e.key === 'Backspace') keyToFlash = '‚å´';
            
            if(keyToFlash && !isPaused && document.getElementById('category-screen').style.display === 'none') {
                triggerFeedback('tap');
                flashKey(keyToFlash);
                handleInput(e.key);
            }
        });
        
    </script>
</body>
</html>
